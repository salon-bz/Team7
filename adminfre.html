<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin</title>

  <style>
    :root {
      --bg: #030511;
      --card: #0b0f1f;
      --accent: #00ffff;
      --accent2: #ff00ff;
      --text: #e9f1ff;
      --text-soft: rgba(230,230,240,0.6);
      --border: rgba(255,255,255,0.1);
    }

    *{box-sizing:border-box;}
    body {
      margin: 0;
      font-family: "Inter", system-ui, Arial;
      background: radial-gradient(circle at top left, #02040a, #060712 70%);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Header */
    header {
      width: 100%;
      max-width: 900px;
      text-align: center;
      margin-top: 70px;
      margin-bottom: 10px;
    }

    h2 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 8px var(--accent2), 0 0 16px var(--accent);
    }

    small {
      color: var(--text-soft);
      font-size: 14px;
    }

    /* Bot√≥n flotante arriba */
    #toggleVideo {
      position: fixed;
      top: 15px;
      right: 20px;
      z-index: 100;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 0 10px var(--accent2), 0 0 20px var(--accent);
      transition: 0.3s;
    }
    #toggleVideo:hover {
      transform: scale(1.1);
      box-shadow: 0 0 15px var(--accent2), 0 0 30px var(--accent);
    }

    /* Panel oculto del video */
    #videoSection {
      position: fixed;
      top: 70px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      padding: 14px;
      border-radius: 12px;
      width: 320px;
      display: none;
      box-shadow: 0 0 15px rgba(255,0,255,0.3);
      z-index: 10;
    }

    #videoSection label { font-size: 13px; color: var(--text-soft); }
    #videoSection input {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(0,255,255,0.3);
      background: #0b1020;
      color: var(--text);
      outline: none;
    }
    #videoSection input:focus { box-shadow: 0 0 8px var(--accent); }

    .btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      font-size: 13px;
    }
    .btn.support {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #fff;
      box-shadow: 0 0 10px var(--accent);
    }
    .btn.delete {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn.delete:hover { background: rgba(255,255,255,0.08); }
    .btn.support:hover { filter: brightness(1.2); }

    /* üîπ Contenedor centrado abajo */
    #solList {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-top: 30px;
      width: 100%;
      max-width: 900px;
    }

    /* üîπ Caja grande */
    .item {
      width: 100%;
      background: #0c1227;
      border-radius: 18px;
      padding: 20px;
      border: 1px solid rgba(0,255,255,0.25);
      box-shadow: 0 0 12px rgba(0,255,255,0.3);
      transition: 0.25s;
    }
    .item:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 18px rgba(255,0,255,0.4);
    }

    .thumb {
      width: 100%;
      height: 250px;
      border-radius: 12px;
      overflow: hidden;
      background: #0b0f1a;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      cursor: pointer;
    }

    .meta {
      font-size: 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .meta b { color: var(--accent); text-shadow: 0 0 4px var(--accent2); }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

  </style>
</head>
<body>

<!-- Bot√≥n peque√±o flotante -->
<button id="toggleVideo">‚öôÔ∏è</button>

<!-- Secci√≥n de configuraci√≥n video -->
<div id="videoSection">
  <label>Link del video tutorial (YouTube)</label>
  <input id="videoInput" type="text" placeholder="https://www.youtube.com/watch?v=..." />
  <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
    <button id="saveVideo" class="btn support">Guardar</button>
    <button id="loadVideo" class="btn delete">Cargar</button>
    <button id="deleteVideo" class="btn delete">Borrar</button>
  </div>
</div>

<header>
  <h2>Panel de Solicitudes</h2>
  <small>Conectado con Firebase ‚Äî actualizaci√≥n en tiempo real</small>
</header>

<div id="solList"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import {
    getFirestore, collection, onSnapshot,
    doc, deleteDoc, setDoc, getDoc, query
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0nZkL5C3CH60ogOh1ekTor9E1uqN1Ibk",
    authDomain: "soportedrip.firebaseapp.com",
    projectId: "soportedrip",
    storageBucket: "soportedrip.firebasestorage.app",
    messagingSenderId: "258679857031",
    appId: "1:258679857031:web:3dba66238f434539097d22"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const solList = document.getElementById('solList');
  const videoInput = document.getElementById('videoInput');
  const saveVideo = document.getElementById('saveVideo');
  const loadVideo = document.getElementById('loadVideo');
  const deleteVideo = document.getElementById('deleteVideo');
  const toggleVideo = document.getElementById('toggleVideo');
  const videoSection = document.getElementById('videoSection');

  toggleVideo.addEventListener('click', ()=>{
    videoSection.style.display = videoSection.style.display === 'block' ? 'none' : 'block';
  });

  function renderSolicitud(id, data){
    const item = document.createElement('div');
    item.className = 'item';
    item.id = 'sol-' + id;

    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    if(data.imgLink){
      const img = document.createElement('img');
      img.src = data.imgLink;
      img.alt = 'img';
      img.addEventListener('click', ()=> window.open(data.imgLink, '_blank'));
      thumb.appendChild(img);
    } else {
      thumb.innerHTML = '<div style="color:rgba(200,200,210,0.4);font-size:14px;text-align:center">Sin imagen</div>';
    }

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `
      <div><b>Descripci√≥n:</b> ${escapeHtml(shorten(data.descripcion,250))}</div>
      <div><b>WhatsApp:</b> ${escapeHtml(data.whatsapp)}</div>
      <div><b>D√≠as:</b> ${escapeHtml(String(data.dias))}</div>
      <div style="font-size:13px;color:var(--text-soft)"><b>Creado:</b> ${escapeHtml(data.createdAt || '')}</div>
    `;

    const actions = document.createElement('div');
    actions.className = 'actions';

    const supportBtn = document.createElement('button');
    supportBtn.className = 'btn support';
    supportBtn.textContent = 'Dar soporte';

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn delete';
    deleteBtn.textContent = 'Eliminar';

    supportBtn.addEventListener('click', async ()=>{
      const wa = data.whatsapp || '';
      const digits = wa.replace(/[^\d]/g,'');
      if(!digits){ alert('N√∫mero de WhatsApp inv√°lido.'); return; }
      const msg = encodeURIComponent('Hola, estoy aqu√≠ para darte soporte de tu compra, ya te resuelvo el problema.');
      window.open(`https://wa.me/${digits}?text=${msg}`, '_blank');
      try{ await deleteDoc(doc(db, 'solicitudes', id)); } catch(e){ console.error(e); }
    });

    deleteBtn.addEventListener('click', async ()=>{
      if(!confirm('¬øEliminar esta solicitud permanentemente?')) return;
      try{ await deleteDoc(doc(db, 'solicitudes', id)); } catch(e){ console.error(e); }
    });

    actions.appendChild(supportBtn);
    actions.appendChild(deleteBtn);
    item.appendChild(thumb);
    item.appendChild(meta);
    item.appendChild(actions);
    return item;
  }

  function shorten(text, n=250){ return (!text)?'':(text.length>n?text.slice(0,n)+'...':text); }
  function escapeHtml(unsafe){
    if(!unsafe) return '';
    return unsafe.replaceAll('&',"&amp;").replaceAll('<',"&lt;").replaceAll('>',"&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  const colRef = collection(db, 'solicitudes');
  const q = query(colRef);
  onSnapshot(q, (snapshot)=>{
    solList.innerHTML = '';
    snapshot.docs.forEach(docSnap=>{
      solList.appendChild(renderSolicitud(docSnap.id, docSnap.data()));
    });
  });

  const cfgDocRef = doc(db, 'config', 'tutorial');
  saveVideo.addEventListener('click', async ()=>{
    const val = videoInput.value.trim();
    if(!val){ alert('Ingresa un link v√°lido.'); return; }
    try{ await setDoc(cfgDocRef, { youtube: val }); alert('Link guardado.'); }
    catch(e){ console.error(e); alert('Error al guardar.'); }
  });
  loadVideo.addEventListener('click', async ()=>{
    try{
      const snap = await getDoc(cfgDocRef);
      if(snap.exists()) videoInput.value = snap.data().youtube || '';
      else videoInput.value = '';
      alert('Link cargado.');
    } catch(e){ console.error(e); alert('Error al cargar.'); }
  });
  deleteVideo.addEventListener('click', async ()=>{
    if(!confirm('¬øEliminar completamente el video tutorial?')) return;
    try{ await deleteDoc(cfgDocRef); videoInput.value = ''; alert('Eliminado.'); }
    catch(e){ console.error(e); alert('Error eliminando.'); }
  });
</script>
</body>
</html>
